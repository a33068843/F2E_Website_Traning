const datas = [
  {
    "ID": "C2_315080000H_080442",
    "Name": "2021南島族群婚禮",
    "Description": "本處轄區位於高屏山麓，在轄管的6個鄉區中，有5個鄉區為原住民地區，族群包含魯凱、排灣、布農及拉阿魯哇族等，呈現多元的原住民文化特色。為推廣本轄特有的原住民文化，帶動部落觀光發展，希望藉由「南島族群婚禮活動」之辦理，以原住民傳統婚禮為主軸，運用觀光行銷手法，將婚禮活動包裝為具有文化特色的觀光活動，活動期間並結合轄區特色民宿、工藝、美食、伴手禮等資源及遊程安排，期盼參與活動的新人、家屬與遊客深度體驗原住民文化及婚禮特色，並帶動觀光發展及地方產業效益。「南島族群婚禮」系列活動將於每年3月份舉辦，規劃以排灣族傳統婚禮為活動主軸，藉以行銷推廣茂林國家風景區旅遊線，讓更多遊客參與活動。本系列活動將運用觀光行銷手法，結合轄區工藝、美食與伴手禮等資源及套裝遊程安排，使參與活動的新人、家屬與遊客能深度體驗原住民文化及婚禮特色，藉以帶動觀光發展及地方產業，並達成行銷轄內觀光遊憩景點和推廣原鄉部落景致之目標。※ 為因應新冠肺炎疫情，2021南島族群婚禮活動決議延期至11月辦理。    開幕活動：11/12（星期五）    新人之夜：11/19（星期五）    主婚禮活動：11/20（星期六）    部落市集：11月每個星期六、日，共8日    11/6、11/7、11/13、11/14、11/20、11/21、11/27、11/28",
    "Location": "屏東縣 霧台鄉",
    "Address": "霧台部落文化廣場",
    "Organizer": "交通部觀光局茂林國家風景區管理處",
    "StartTime": "2021-11-12T00:00:00+08:00",
    "EndTime": "2021-11-28T00:00:00+08:00",
    "WebsiteUrl": "https://theme.maolin-nsa.gov.tw/wedding2021/index.html",
    "Picture": {
      "PictureUrl1": "https://www.taiwan.net.tw/att/event/85b5a231-dee8-490d-94d2-9683ed92e656.jpg",
      "PictureDescription1": "盪鞦韆後的新人",
      "PictureUrl2": "https://www.taiwan.net.tw/att/event/9ddd8033-07a8-42b5-924a-419ece3d1120.jpg",
      "PictureDescription2": "新娘盪鞦韆",
      "PictureUrl3": "https://www.taiwan.net.tw/att/event/c6ff0f9b-ed1b-4463-b513-1e687547cc5f.jpg",
      "PictureDescription3": "新人喝連杯酒"
    },
    "Position": {
      "PositionLon": 120.73097229003906,
      "PositionLat": 22.74406623840332,
      "GeoHash": "wsjc7k3tg"
    },
    "Class1": "節慶活動",
    "Class2": "藝文活動",
    "City": "屏東縣",
    "SrcUpdateTime": "2021-11-12T01:12:24+08:00",
    "UpdateTime": "2021-11-12T02:40:14+08:00"
  },
  {
    "ID": "C2_315080000H_080498",
    "Name": "2021台灣好湯-溫泉美食嘉年華",
    "Description": "時序逐漸進入冬天，也正式宣告臺灣已進入溫泉泡湯旺季！臺灣得天獨厚，擁有冷泉、熱泉、濁泉、海底泉等多樣性泉質，是世界知名的溫泉勝地。交通部觀光局自民國96年開始每年結合溫泉保健養生特色及現代人健康飲食需求，將臺灣「溫泉」及「美食」兩大觀光資源整合規劃推出「溫泉美食嘉年華」活動。該活動每年在全臺各地同時登場，並從全臺19個溫泉區選出啟動地點。「溫泉美食嘉年華」不但讓國內遊客全臺溫泉區泡透透，處處都享優惠，對國際觀光客也是深具魅力，更是帶動秋冬臺灣溫泉旅遊熱潮的年度盛事。活動期間，全臺溫泉區都將陸續辦理溫泉美食系列活動，並整合全臺各縣市溫泉區上百家業者，集合各溫泉區景點、人文風情與特產介紹，推薦優質店家，同時更提供好康優惠陸續引爆泡湯話題。",
    "Location": "臺北市 北投區",
    "Address": "新北投溫泉區",
    "Organizer": "交通部觀光局",
    "StartTime": "2021-11-12T00:00:00+08:00",
    "EndTime": "2022-04-30T00:00:00+08:00",
    "WebsiteUrl": "https://taiwanhotspring.net/",
    "Picture": {
      "PictureUrl1": "https://www.taiwan.net.tw/att/event/388b0f82-b621-4be2-8c5f-4dac47482d01.jpg",
      "PictureDescription1": "礁溪溫泉公園",
      "PictureUrl2": "https://www.taiwan.net.tw/att/event/f4adba8f-082f-45e6-9c33-36bbbab062d3.jpg",
      "PictureDescription2": "礁溪溫泉",
      "PictureUrl3": "https://www.taiwan.net.tw/att/event/636fe103-06a9-4ab8-902f-8ed983291c9e.jpg",
      "PictureDescription3": "四重溪溫泉季-旭海溫泉公園"
    },
    "Position": {
      "PositionLon": 121.50264739990234,
      "PositionLat": 25.13694190979004,
      "GeoHash": "wsqrhb592"
    },
    "Class1": "節慶活動",
    "Class2": "藝文活動",
    "City": "臺北市",
    "SrcUpdateTime": "2021-11-12T01:12:24+08:00",
    "UpdateTime": "2021-11-12T02:40:14+08:00"
  },
  {
    "ID": "C2_315080800H_003797",
    "Name": "台灣好湯活動",
    "Description": "無",
    "Location": "to see the official site",
    "Address": "花蓮縣970花蓮市",
    "Phone": "886-6-7861000",
    "Organizer": "花東縱谷國家風景區管理處",
    "StartTime": "2021-11-12T00:00:00+08:00",
    "EndTime": "2022-04-30T23:59:59+08:00",
    "Picture": {},
    "Position": {
      "PositionLon": 121.32344055175781,
      "PositionLat": 23.019805908203125,
      "GeoHash": "wsn6by9h1"
    },
    "Class1": "年度活動",
    "City": "臺東縣",
    "SrcUpdateTime": "2021-11-12T01:12:24+08:00",
    "UpdateTime": "2021-11-12T02:40:14+08:00"
  },
  {
    "ID": "C2_397000000A_004209",
    "Name": "2021高雄設計節－後疫時代",
    "Description": "無",
    "Location": "to see the official site",
    "Address": "高雄市803鹽埕區大勇路一號",
    "Phone": "886-7-7995678",
    "Organizer": "高雄市政府",
    "StartTime": "2021-11-12T00:00:00+08:00",
    "EndTime": "2022-01-02T23:59:59+08:00",
    "Picture": {},
    "Position": {
      "PositionLon": 120.28153228759766,
      "PositionLat": 22.619979858398438,
      "GeoHash": "wsj89jf6f"
    },
    "Class1": "年度活動",
    "City": "高雄市",
    "SrcUpdateTime": "2021-11-12T01:12:24+08:00",
    "UpdateTime": "2021-11-12T02:40:14+08:00"
  }
]

// 搜尋元件
function searchDropdown(dropdown) {
  const typeDropdownDefault = dropdown.find('.default .text')
  const typeDropdownOptions = dropdown.find('.options li')
  dropdown.on('click', function() {
    dropdown.toggleClass('active');
  })
  typeDropdownOptions.on('click', function() {
    const target = $(this).find('.text').text();
    typeDropdownDefault.text(target);
  })
}
// 拿到搜尋參數
function getSettings() {
}
// 搜尋結果個數
function checkResults() {
  const checkResults = $('#checkResults');
  const hasResults = checkResults.find('.card_simple').length
  const simpleWrapper = checkResults.find('.card_simpleWrapper')
  const emptyWrapper = checkResults.find('.card_emptyWrapper')
  if (hasResults) {
    if (!simpleWrapper.is(":visible")) simpleWrapper.toggle();
    if (!!emptyWrapper.is(":visible")) emptyWrapper.toggle();
    return;
  }
  if (!!simpleWrapper.is(":visible")) simpleWrapper.toggle();
  if (!emptyWrapper.is(":visible")) emptyWrapper.toggle();
}
// 取得授權
function getAuthority() {
  const id = 'e7d52bd12c9d4392b114afddbde9e654'
  const key = 'x1kLGusSVGFE3vnaLUgiQYwGcfo'
  const GMTString = new Date().toGMTString();
  const ShaObj = new jsSHA('SHA-1', 'TEXT');
  ShaObj.setHMACKey(key, 'TEXT');
  ShaObj.update('x-date: ' + GMTString);
  const HMAC = ShaObj.getHMAC('B64');
  const Authorization = 'hmac username=\"' + id + '\", algorithm=\"hmac-sha1\", headers=\"x-date\", signature=\"' + HMAC + '\"';
  return { 'Authorization': Authorization, 'X-Date': GMTString };
}
// 搜尋功能
const localSettings = JSON.parse(localStorage.getItem('setting'));
function search(localSettings, callApi) {
  const {
    kindSetting   = null,
    citySetting   = null,
    topicSetting  = null,
    inputSetting  = null,
    dataCount,
  } = localSettings;

  switch(callApi) {
    case 'recentScene':
      recentScene();
      break;
    case 'recentEvent':
      recentEvent();
      break;
    case 'recentFood':
      recentFood();
      break;
  }
  $('.breadcrumbs li').last().text(kindSetting);
}
// 將不同地方用到的 API 分出來

// 拿取位置資訊
function getPosition() {
  return new Promise((resolve, reject) => {
    return navigator.geolocation.getCurrentPosition(resolve, reject);
  })
}
// 最近活動
function recentEvent() {
  const selectDom = $('#recentEvent').find('.card_detailWrapper');
  const nowDate = new Date().toISOString().split('T')[0];
  const render = (data) => {
    const startDate = data.StartTime.split('T')[0].replaceAll('-','/');
    const endDate = data.EndTime.split('T')[0].replaceAll('-','/');
    return (`
      <div class="card_detail">
        <div class="img">
          <img src="${data.Picture.PictureUrl1 ? data.Picture.PictureUrl1 : "../images/noImage_x1.png"}">
        </div>
        <div class="description">
          <div class="dateWrapper">
            <span class="date_begin">${startDate}</span>
            <span class="date_dash"></span>
            <span class="date_finish">${endDate}</span>
          </div>
          <div class="title">${data.Name}</div>
          <div class="bottom_container">
            <div class="locationWrapper">
              <div class="icon"></div>
              <div class="text">${data.City}</div>
            </div>
            <div class="readMoreButton">
              <div class="text">詳細介紹</div><i class="fas fa-chevron-right"></i>
            </div>
          </div>
        </div>
      </div>
    `)
  }
  const item = datas.flatMap((data) => {
    return render(data);
  })
  selectDom.html(item);
  // axios.get(
  //   `https://ptx.transportdata.tw/MOTC/v2/Tourism/Activity?$filter=date(StartTime)%20ge%20${nowDate}&$orderby=StartTime%20asc&$top=4&$format=JSON`,
  //   { headers: getAuthority() }
  // ).then((response) => {
  //   const datas = response.data;
  //   const item = datas.flatMap((data) => {
  //     return render(data);
  //   })
  //   selectDom.html(item);
  // });
}
// 熱門打卡景點
function recentScene() {
  const selectDom = $('#recentScene').find('.card_simpleWrapper');
  const render = (data) => {
    return (`
      <div class="card_simple">
        <div class="img">
          <img src="${data.Picture.PictureUrl1 ? data.Picture.PictureUrl1 : "../images/noImage_x2.png"}">
        </div>
        <div class="title">${data.Name}</div>
        <div class="locationWrapper">
          <div class="icon"></div>
          <div class="text">${data.Address.substring(0,3)}</div>
        </div>
      </div>
    `)
  }
  axios.get(
    `https://ptx.transportdata.tw/MOTC/v2/Tourism/ScenicSpot?$top=4&$format=JSON`,
    { headers: getAuthority() }
  ).then((response) => {
    const datas = response.data;
    const item = datas.flatMap((data) => {
      return render(data);
    })

    console.log(item);
    selectDom.html(item);
  });

}
// 回訪美食
async function recentFood() {
  const selectDom = $('#recentFood').find('.card_simpleWrapper');
  const currentPostion = await getPosition()
    .then((position) => {
      const latitude = position.coords.latitude;
      const longitude = position.coords.longitude;
      return `&$spatialFilter=nearby(${latitude}, ${longitude}, 1000)`;
    })
    .catch((err) => {
      return ``;
    })
  ;
  const render = (data) => {
    return (`
      <div class="card_simple">
        <div class="img">
          <img src="${data.Picture.PictureUrl1 ? data.Picture.PictureUrl1 : "../images/noImage_x2.png"}">
        </div>
        <div class="title">${data.Name}</div>
        <div class="locationWrapper">
          <div class="icon"></div>
          <div class="text">${data.Address.substring(0,3)}</div>
        </div>
      </div>
    `)
  }
  axios.get(
    `https://ptx.transportdata.tw/MOTC/v2/Tourism/Restaurant?$top=4${currentPostion}&$format=JSON`,
    { headers: getAuthority() }
  ).then((response) => {
    const datas = response.data;
    const item = datas.flatMap((data) => {
      return render(data);
    })
    selectDom.html(item);
  });
}

// 搜索頁面分頁
function searchResult() {
  const selectDom = $('#checkResults').find('.card_simpleWrapper');
  const pagination = $('#pagination');
  const render = (data) => {
    return (`
      <div class="card_simple">
        <div class="img">
          <img src="${data.Picture.PictureUrl1 ? data.Picture.PictureUrl1 : "../images/noImage_x2.png"}">
        </div>
        <div class="title">${data.Name}</div>
        <div class="locationWrapper">
          <div class="icon"></div>
          <div class="text">${data.Address.substring(0,3)}</div>
        </div>
      </div>
    `)
  }
  const renderPage = (pagination) => {
    pagination.find('a').addClass('paginationButton');
    pagination.find('.paginationjs-prev > a').html(`<i class="fas fa-chevron-left"></i>`);
    pagination.find('.paginationjs-next > a').html(`<i class="fas fa-chevron-right"></i>`);
  }
  axios.get(
    `https://ptx.transportdata.tw/MOTC/v2/Tourism/ScenicSpot?$top=22&$format=JSON`,
    { headers: getAuthority() }
  ).then((response) => {
    const datas = response.data;
    console.log(datas);
    pagination.pagination({
      dataSource: datas,
      pageSize: 2,
      callback: function(datas, pagination) {
        
        renderPage(pagination.el);
        const item = datas.flatMap((data) => {
          return render(data);
        })
        selectDom.html(item);
      }
    })
  });
}

$(document).ready(function() {
  const currentPage = location.pathname;
  // if (currentPage === '/result.html') search();
  if (currentPage === '/result.html') searchResult();

  const a = !!localStorage.getItem('search');
  const localSettings = JSON.parse(localStorage.getItem('setting'));
  localStorage.clear();
  getPosition()
  // 首頁串 API
  const hasRecentEvent = !!$('#recentEvent').length;
  if (hasRecentEvent) {
    const searchCondition = {};
    search(searchCondition, 'recentEvent');
  }
  const hasRecentScene = !!$('#recentScene').length;
  if (hasRecentScene) {
    const searchCondition = {};
    search(searchCondition, 'recentScene');
  }
  const hasRecentFood = !!$('#recentFood').length;
  if (hasRecentFood) {
    const searchCondition = {};
    search(searchCondition, 'recentFood');
  }

  // 搜尋元件判斷處
  const kindDropdown = $('#searchDropdown_kind');
  const hasKindDropdown = !!kindDropdown.length;
  if (hasKindDropdown) searchDropdown(kindDropdown);

  const cityDropdown = $('#searchDropdown_city');
  const hasCityDropdown = !!cityDropdown.length;
  if (hasCityDropdown) searchDropdown(cityDropdown);

  const topicDropdown = $('#searchDropdown_topic');
  const hasTopicDropdown = !!topicDropdown.length;
  if (hasTopicDropdown) searchDropdown(topicDropdown);

  // 拿取搜尋設定
  
  // 搜尋結果個數
  checkResults();
  const searchButton = $('.searchButton')

  searchButton.on('click', function() {
    const kindSetting = $('.breadcrumbs').length ?
      $('.breadcrumbs li').last().text() : kindDropdown.find('.default .text').text();
    const citySetting = cityDropdown.find('.default .text').text()
    const topicSetting = topicDropdown.find('.default .text').text()
    const inputSetting = $('.searchInput').val();
    const settings = {
      "kindSetting": kindSetting,
      "citySetting": citySetting,
      "topicSetting": topicSetting,
      "inputSetting": inputSetting,
    }
    localStorage.setItem('setting', JSON.stringify(settings))
    checkResults();
    if (currentPage !== '/result.html') {
      localStorage.setItem('search', true);
      location.href = './result.html';
    }
  })
  checkResults()
  //
  // 滑動圖片
  if ($('#a').length) {
    $('#a').lightSlider({
      item: 1,
      loop:true,
      auto: false,
      addClass: 'customSlider',
      pauseOnHover: true,
      pause: 3000,
      slideMargin: 0,
      enableDrag: false,
    });
  }
});
